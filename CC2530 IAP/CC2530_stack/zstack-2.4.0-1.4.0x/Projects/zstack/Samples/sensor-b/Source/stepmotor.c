/*********************************************************************************************
* 文件：stepmotor.c
* 作者：zonesion 2016.4.13
* 说明：电机驱动程序
*       通过P0_0、P0_1端口控制电机的工作
* 修改：Chenkm 2017.01.10 修改代码格式，增加代码注释和文件说明
* 注释：
*********************************************************************************************/

/*********************************************************************************************
* 头文件
*********************************************************************************************/
#include <ioCC2530.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "stepmotor.h"
#include "delay.h"

/*********************************************************************************************
* 宏定义
*********************************************************************************************/
#define CLKDIV  ( CLKCONCMD & 0x07 )    
#define PIN_STEP         P0_0   
#define PIN_DIR          P0_1
#define PIN_EN 		 P0_2

/*********************************************************************************************
* 全局变量
*********************************************************************************************/
static unsigned int dir = 0;

void stepmotor_init(void)
{
  APCFG &= ~0x01;                                                //模拟 I/O 失能  
  P0SEL &= ~0X07;												//配置p0_0、p0_1、p0_2为输出引脚
  P0DIR |= 0X07;
  PIN_EN = 1;
}

/*********************************************************************************************
* 名称：step(int dir,int steps)
* 功能：电机单步
* 参数：int dir,int steps
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void step(int dir,int steps)
{
  int i;
  if (dir) PIN_DIR = 1;											//步进电机方向设置
  else PIN_DIR = 0;
  delay_us(5);													//延时5us
  for (i=0; i<steps; i++){										//步进电机旋转
    PIN_STEP = 0;
   delay_us(80);
    PIN_STEP = 1;
   delay_us(80);
  }
}

/*********************************************************************************************
* 名称：forward()
* 功能：电机正转
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void forward(int data)
{
  dir = 0;														//步进电机方向设置
  PIN_EN = 0;
  step(dir, data);												//启动步进电机
  PIN_EN = 1;
}

/*********************************************************************************************
* 名称：reversion()
* 功能：电机反转
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void reversion(int data)
{
  dir = 1;														//步进电机方向设置
  PIN_EN = 0;
  step(dir, data);												//启动步进电机

  PIN_EN = 1;

}